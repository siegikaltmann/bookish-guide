---
title: Woche 03 – HC-SR04 Abstandssensor
date: 2025-10-19
cover: /assets/cover-lab.jpg
excerpt: "Ultraschallentfernung messen mit HC-SR04 (Trigger/Echo), Zeitmessung, Mittelwertbildung, Fehlerbehandlung."
tags: [sensor, hcsr04, micropython, time_pulse_us]
---

## Ziele
- Funktionsprinzip HC-SR04 verstehen (Trigger/Echo).
- **Zeit in µs** messen und auf **Distanz in cm** umrechnen.
- Robust messen: Mittelwert, Timeouts, Messfenster.

## Schaltung
- **Trig** → GP3 (OUT)  
- **Echo** → GP2 (IN)  
- **GND** → GND, **VCC** → 5 V  
> **Wichtig:** Echo-Pegel ist oft 5 V. Nutze einen Spannungsteiler (z. B. 10 kΩ/15 kΩ) auf ~3.3 V *oder* ein Level-Shifter.

## Code (MicroPython)
```python
uPython

from machine import Pin, time_pulse_us
import utime

TRIG = Pin(3, Pin.OUT)
ECHO = Pin(2, Pin.IN)

def read_distance_cm():
    # Trigger-Puls (10 µs)
    TRIG.low()
    utime.sleep_us(2)
    TRIG.high()
    utime.sleep_us(10)
    TRIG.low()

    # Echo-Zeit in µs messen (Timeout 30 ms)
    dur = time_pulse_us(ECHO, 1, 30000)
    if dur < 0:
        # -2 = Timeout (kein Puls), -1 = zu lange/high blieb
        return None

    # Schallgeschwindigkeit ~343 m/s -> 0.0343 cm/µs
    # Hin- und Rückweg -> /2, üblich: /58 ≈ cm
    dist = dur / 58.0
    return dist

def read_avg_cm(n=5):
    vals = []
    for _ in range(n):
        d = read_distance_cm()
        if d is not None and 2 <= d <= 400:  # Datenblattbereich
            vals.append(d)
        utime.sleep_ms(60)
    if not vals:
        return None
    # Ausreißer filtern (einfach): mittlere 60% nehmen
    vals.sort()
    k = max(1, int(len(vals)*0.2))
    core = vals[k:-k] if len(vals) > 2*k else vals
    return sum(core)/len(core)

while True:
    d = read_avg_cm(5)
    if d is None:
        print("Messfehler/Timeout")
    else:
        print("Entfernung: {:.1f} cm".format(d))
    utime.sleep_ms(200)
```

## Aufgaben
1. LED-Warnung: Unter 15 cm → LED rot (oder Onboard-LED an).
2. Fenster: Nur Werte zwischen 5–150 cm zulassen; alles andere ignorieren.
3. Bonus (Glättung): Implementiere gleitenden Mittelwert (MA) über die letzten 10 Messungen.

### Abgabe
- Foto der Schaltung + kurzer Mess-Screenshot der Konsole.
- Dein Code (mit Kommentaren).
- 3 Erkenntnisse (z. B. Timeouts, Ausreißer, Verkabelung).

- Ressourcen:
Kurzleitfaden (PDF): {{ '/assets/labor-kurzleitfaden.pdf' | absolute_url }}
